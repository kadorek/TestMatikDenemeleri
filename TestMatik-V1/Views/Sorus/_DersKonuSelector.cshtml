@using Forloop.HtmlHelpers
@using Newtonsoft.Json

@model TestMatik_V1.Models.Soru


@{
    var db = new TestMatik_V1.Models.VerilerEntities();
    var TumDersler = db.Ders.ToList();
    TumDersler.Insert(0, new TestMatik_V1.Models.Der { Id = 0, Ad = "Ders Seçiniz" });

    var konular = new List<TestMatik_V1.Models.Konu>();
    if (Model.KonuId > 0)
    {
        konular = Model.Konu.Der.Konus.ToList();
    }

}

<div class="form-group">
    @Html.Label("Ders", htmlAttributes: new { @class = "control-label col-md-2" })
    <div class="col-md-10">
        @Html.DropDownList("slcDersler", new SelectList(TumDersler, "Id", "Ad", Model.Konu != null ? Model.Konu.DersId : 0), htmlAttributes: new { @class = "form-control" })
    </div>
</div>

<div class="form-group">
    @Html.LabelFor(model => model.KonuId, "KonuId", htmlAttributes: new { @class = "control-label col-md-2" })
    <div class="col-md-10">
        @*<select id="KonuId" name="KonuId" class="form-control">
            @foreach (var k in konular)
            {
                <option value="@k.Id" @(k.Id == Model.KonuId ? "selected" : "")>@k.Ad</option>
            }
        </select>
        @(konular.Count)*@
        @Html.DropDownList("KonuId", new SelectList(konular,"Id","Ad",Model.KonuId>0?Model.KonuId:0), htmlAttributes: new { @class = "form-control" })
        @Html.ValidationMessageFor(model => model.KonuId, "", new { @class = "text-danger" })
    </div>
</div>


@using (Html.BeginScriptContext())
{
    Html.AddScriptBlock(
@<script type="text/javascript">
        $(document).ready(function () {
            @*console.log("@(JsonConvert.SerializeObject(konular,new JsonSerializerSettings { ReferenceLoopHandling = ReferenceLoopHandling.Ignore,Formatting=Formatting.None, StringEscapeHandling=StringEscapeHandling.Default}))");*@
                //$("#KonuId").empty();
                $("#slcDersler").on("change", function () {
                    $("#KonuId").empty();
                    $.ajax({
                        type: 'POST',
                        url: '@Url.Action("DersinKonulari")', // we are calling json method
                        dataType: 'json',
                        data: { id: $("#slcDersler").val() },
                        success: function (konular) {
                            // states contains the JSON formatted list
                            // of states passed from the controller

                            $("#KonuId").append('<option value="' + "0" + '">' + "Konu Seçiniz" + '</option>');
                            //debugger;
                            $.each(konular, function (i, konu) {
                                $("#KonuId").append('<option value="' + konu.Value + '">' + konu.Text + '</option>');
                                // here we are adding option for States
                            });

                        },
                        error: function (ex) {
                            alert('Failed to retrieve konular.' + ex);
                        }
                    });

                })
            });
</script>
, true);
}